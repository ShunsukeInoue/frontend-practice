import json, math

def to_obj(x):
    return x if isinstance(x, dict) else json.loads(x)

def mean(xs):
    xs = [v for v in xs if isinstance(v, (int, float))]
    return sum(xs) / len(xs) if xs else None

def extract_avg_logprob(resp: dict) -> float:
    choice = resp.get("choices", [{}])[0]
    lp = choice.get("logprobs") or {}

    if isinstance(lp, dict) and isinstance(lp.get("content"), list):
        vals = [t.get("logprob") for t in lp["content"] if isinstance(t, dict)]
        v = mean(vals)
        if v is not None:
            return v

    raise ValueError("logprobs形式が想定外")

def sigmoid(x): 
    return 1.0 / (1.0 + math.exp(-x))

def compact(x, sig=12):
    # Difyの「20桁未満」制約対策：有効数字を絞って float に戻す
    return float(f"{x:.{sig}g}")

resp_withA = to_obj(withA)
resp_noA   = to_obj(noA)

avg_withA = extract_avg_logprob(resp_withA)
avg_noA   = extract_avg_logprob(resp_noA)

delta = avg_withA - avg_noA
k = 3.0
score = sigmoid(k * delta)  # 0〜1

result = {
    "answer_relevance": compact(score, 12),
    "delta": compact(delta, 12),
    "avg_withA": compact(avg_withA, 12),
    "avg_noA": compact(avg_noA, 12),
}
