import os
import time
import math
import random
import boto3
from botocore.exceptions import ClientError

VECTOR_BUCKET = os.environ["VECTOR_BUCKET_NAME"]
INDEX_NAME    = os.environ["VECTOR_INDEX_NAME"]
DIM           = int(os.environ.get("VECTOR_DIM", "1536"))
TOTAL         = int(os.environ.get("TOTAL", "1000"))
BATCH_SIZE    = 500

client = boto3.client("s3vectors")

def make_vector(seed: int) -> list[float]:
    rng = random.Random(seed)
    v = [rng.uniform(-1.0, 1.0) for _ in range(DIM)]
    norm = math.sqrt(sum(x*x for x in v))
    if norm == 0.0:
        v[0] = 1.0
        norm = 1.0
    return [float(x / norm) for x in v]  # float32相当でOK（boto3側で数値配列として送る）

def put_with_retry(vectors, max_retry=8):
    for attempt in range(max_retry):
        try:
            client.put_vectors(
                vectorBucketName=VECTOR_BUCKET,
                indexName=INDEX_NAME,
                vectors=vectors,
            )
            return
        except ClientError as e:
            code = e.response.get("Error", {}).get("Code", "")
            if code in ["ServiceUnavailableException", "ThrottlingException", "TooManyRequestsException"]:
                sleep = min(2 ** attempt, 10) + random.random()
                time.sleep(sleep)
                continue
            raise

def chunks(lst, n):
    for i in range(0, len(lst), n):
        yield lst[i:i+n]

all_vectors = []
for i in range(1, TOTAL + 1):
    all_vectors.append({
        "key": f"test_vector{i}",
        "data": {"float32": make_vector(i)},
        "metadata": {"source": "dummy", "id": i},
    })

for batch in chunks(all_vectors, BATCH_SIZE):
    put_with_retry(batch)

print("Done.")
