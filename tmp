flowchart TB
  %% Actors / Systems
  subgraph ExaSide["exa（規程・ナレッジ管理）"]
    ExaDocs["規程ドキュメント更新\n（追加/改定/削除）"]
    ExaIndex["ナレッジ再生成/再インデックス\n（RAG用）"]
    ExaAccessAPI["規程アクセス可否API\n返却: regulation_id, regulation_name, usable"]
    ExaChatAPI["チャットAPI\nreq: account_info + chat_text"]
  end

  subgraph LocalSide["こちら側（AIユーモ / なんでも案内AI）"]
    Admin["管理者（運用担当）"]
    AdminUI["管理画面\n（規程メタ情報管理）"]
    LocalDB["ローカルDB\n規程メタ情報\n- regulation_id\n- exa_canonical_name\n- category / orders\n- local_status(緊急停止)\n- summary/importance..."]
    SyncJob["同期処理\n（手動 or バッチ）"]
    AppUI["なんでも案内AI UI\n（規程一覧表示/選択）"]
    YumoBackend["AIユーモ Backend\n（ユーザー情報・UI用API・チャット中継）"]
  end

  subgraph Users["利用者"]
    User["ログインユーザー"]
  end

  %% 1) Exa updates regulations
  ExaDocs --> ExaIndex

  %% 2) Admin syncs metadata base list
  Admin --> AdminUI
  AdminUI -->|同期ボタン| SyncJob
  SyncJob -->|GET| ExaAccessAPI
  ExaAccessAPI -->|規程id/名/usable| SyncJob
  SyncJob -->|upsert\n規程名差分更新など| LocalDB

  %% 3) User opens app and sees accessible list
  User --> AppUI
  AppUI -->|一覧取得| YumoBackend
  YumoBackend -->|GET| ExaAccessAPI
  ExaAccessAPI -->|規程id/名/usable| YumoBackend
  YumoBackend -->|JOIN\nexa結果 × LocalDB| LocalDB
  YumoBackend -->|カテゴリでセクショニング\n並び順適用\nfinal_usable = usable AND local_status==enabled| AppUI

  %% 4) User selects regulation and chats
  AppUI -->|規程選択| YumoBackend
  YumoBackend -->|チャット送信\n先頭に注入:\n{exa_canonical_name}に関する質問です。| ExaChatAPI
  ExaChatAPI -->|RAG回答| YumoBackend
  YumoBackend --> AppUI

  %% Notes / edge cases
  LocalDB -.緊急停止.-> YumoBackend
  ExaIndex -.更新遅延がある場合.-> ExaChatAPI
